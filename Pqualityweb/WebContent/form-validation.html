<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Controllo Qualità</title>
	    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
	<link rel="stylesheet" href="assets/form-validation.css">
	<link rel="stylesheet" href="assets/form-register.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
</head>
<body ng-app="myApp">
<header>
	<nav class="navbar navbar-expand-lg navbar-dark" style="background:green;">
  <div class="collapse navbar-collapse" id="navbarText">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item ">
        <a class="nav-link" href="index.html">Home </a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="form-validation.html">Controllo qualità <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="area-riparazioni.html">Area riparazioni</a>
      </li>
    </ul>     
  </div>
</nav>
</header>
	<div ng-controller="CTRL" class="py-5">
    <div class=""  id="first">
        <!-- You only need this form and the form-validation.css -->
<form class="form-validation" >
            <div class="form-title-row">
                <h1>Inserimento prodotto</h1>
            </div>
            <div class="form-row form-input-name-row">
                <label>
                    <span>RFID CODE:</span>
                    <input ng-change="productExists($rootScope)" type="text" name = "target" ng-model="$rootScope.product.target">					
                </label>
<!--
                    Add these three elements to every form row. They will be shown by the
                    .form-valid-data and .form-invalid-data classes (see the JS for an example).
                -->
                <span class="form-invalid-data-sign" id="exist"><i class="fa fa-close"></i></span>
            </div>          
			 <div ng-if="$rootScope.exists" class="form-row">
				<p style="text-align:center">
                <span style="color:orange;text-shadow: 1px 1px black;">Prodotto esistente. Procedendo potrai modificarne la qualità!</span>
				</p>
            </div>  
           <div class="form-row">
                <button id="subutton" ng-click="creaProdotto($rootScope);">Inserisci prodotto</button>
            </div>
        </form>
    </div>	
	<!--Secondo form-->
	   <div class="main-content" id = "second" style="display:none;">
        <!-- You only need this form and the form-register.css -->
        <form class="form-register" >
            <div class="form-register-with-email">
                <div class="form-white-background">
                    <div class="form-title-row">
                        <h1>Dettagli prodotto</h1>
                    </div>
                    <div class="form-row">
                        <label>
                            <span>Nome</span>
                            <input   type="text" name="nome" ng-model = "$rootScope.product.name">					
                        </label>
                    </div>
                    <div class="form-row">
                        <label>
                            <span>Categoria</span>
                            <input type="text" name="cat" ng-model = "$rootScope.product.category">
                        </label>
                    </div>
                    <div class="form-row">
                        <label>
                            <span>Provenienza</span>
                            <input type="text" name="prov" ng-model = "$rootScope.product.provenance">
                        </label>
                    </div>					
					 <div class="form-row">
                        <label>
                            <span>Descrizione</span>
                            <input type="textarea" name="descr" ng-model = "$rootScope.product.description">
                        </label>
                    </div>
                    <div ng-click="creaDetProdotto($rootScope);" class="form-row">
                        <button type="submit">Invia</button>
                    </div>
                </div>
            </div>
         </form>
    </div>
	<!--/Secondo form-->
	<!--Terzo form-->
	 <div class="main-content"  id="third" style="display: none;">
        <!-- You only need this form and the form-validation.css -->
        <form class="form-validation" >
            <div class="form-title-row">
                <h2>CONTROLLO QUALITA'</h2>
            </div>
            <div class="form-row form-input-name-row">
                <label>
                    <span>Qualità:</span>										
										<select  required name = "quality" ng-model="$rootScope.product.quality" >
											<option value="1"> 1</option>
											<option value="2"> 2</option>
											<option value="3"> 3</option>
										</select>
                    <!--<input type="number" min=1 max=3 name = "quality" ng-model="$rootScope.product.quality">-->
		    </label>
			    <!--
                    Add these three elements to every form row. They will be shown by the
                    .form-valid-data and .form-invalid-data classes (see the JS for an example).
                -->
</div>
 <div class="form-row">
<button ng-click="controlloQualita($rootScope);">Inserisci qualità</button>
</div>
        </form>
    </div>
	<!--/ Terzo form-->
	<!-- repair form-->
	    <div class="main-content"  id="four" style="display:none;">
        <!-- You only need this form and the form-validation.css -->
        <form class="form-validation" >
            <div class="form-title-row">
                <h1>Inserimento prodotto</h1>
            </div>
            <div class="form-row form-input-name-row">
                <label>
                    <span>Scrivi Nota:</span>
                    <textarea  type="text" name = "note" ng-model="$rootScope.product.nota" placeholder="Inserisci nota per il prodotto da riparare">
								</textarea>
                </label>
<!-- Add these three elements to every form row. They will be shown by the
                    .form-valid-data and .form-invalid-data classes (see the JS for an example).-->
            </div>
            <div class="form-row">
                <button id="subutton" ng-click="creaRiparazione($rootScope);">Inserisci nota</button>
            </div>
        </form>
    </div>
	<!--/repair form-->
	<!--footer-->
	<!-- Footer -->
  <!-- Footer -->
	<!--/footer-->
	</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script>
		var app =angular.module("myApp",[]);
		app.config(function ($httpProvider) {
  $httpProvider.defaults.headers.common = {};
  $httpProvider.defaults.headers.post = {};
  $httpProvider.defaults.headers.put = {};
  $httpProvider.defaults.headers.patch = {};
});
		app.controller("CTRL", function($rootScope, $http) {
			var scope = $rootScope;
			scope.product = {target : "", name : "", quality:0, category:"", provenance:"", description:"" };
			//Metodo di controllo che dice se il prodotto esiste già:
			//In caso esista già il prodotto bisogna disabiliater il submit!
			scope.productExists = function(scope){
				$http.get('http://localhost:8090/products/tag/'+scope.product.target )
				.success(function(response) {
					console.log(response);
					if (response!=""){
						//document.getElementById("exist").style.display="block";
						//document.getElementById("subutton").disabled = true;
						scope.exists = true;
						//alert("Prodotto esistente!");
					}else{
						scope.exists=false;
						//document.getElementById("subutton").disabled = false;
						//document.getElementById("exist").style.display="none";
					}
					})
					.error(function() {
						console.log("Si è verificato un errore!");
					});
					//Se dopo aver inserito l'input il campo è vuoto allora non posso aggiungere un prodotto vuoto
					if(scope.product.target == ""){
						document.getElementById("exist").style.display="block";
						document.getElementById("subutton").disabled = true;
					}else{
						document.getElementById("subutton").disabled = false;
						document.getElementById("exist").style.display="none";
					}
				};
			scope.creaProdotto = function(scope) {
				console.log(scope.product.target);
				//Se l'utente per sbaglio ha cliccato su aggiungi prodotto appena ha acceduto alla pagina
				if(scope.product.target==""){
					alert("Non hai inserito nessun target: seleziona la casella in cui inserire il testo, successivamente puoi leggere il tag");
					return;
				}
				//Se il prodotto non esiste allora lo creo
				if(!scope.exists ){
				$http({
						method: 'POST',
						url: 'http://localhost:8090/products/create',
						data: $.param({
							target : scope.product.target
						}),
						headers: {'Content-Type': 'application/x-www-form-urlencoded'}
				})
					.success(function() {
						alert("Prodotto aggiunto correttamente!");
						//Una volta creato il prodotto l'operatore verrà indirizzato al form sul controlle qualità se il prodotto esiste
						//Se la variabile exists è True significa che il prodotto esiste e bisogna saltare al controllo qualità senza
						//inserire la referenza del prodotto altrimenti si procede con associazione tag-referenza
						document.getElementById("second").style.display="block";
						document.getElementById("first").style.display="none";
					})
					.error(function() {
						alert("Si è verificato un errore!");
					});
				}
				else{
					//Se il prodotto esiste già vai al terzo form(quello della qualià)
					document.getElementById("first").style.display="none";
					document.getElementById("third").style.display="block";
				}
			};			
			scope.creaDetProdotto = function(scope){
								$http({
										method: 'POST',
										url: 'http://localhost:8090/products/create/details',
										data: $.param({
											target : scope.product.target,
											prov : scope.product.provenance,
											descr : scope.product.description,
											cat : scope.product.category
										}),
										headers: {'Content-Type': 'application/x-www-form-urlencoded'}
									})
									.success(function() {
										alert("Dettagli Prodotto aggiunti correttamente!");
										document.getElementById("third").style.display="block";
										document.getElementById("second").style.display="none";
									})
									.error(function() {
										alert("Si è verificato un errore!");
									});
										console.log(scope.product.target);
										console.log(scope.product.name);			
								var req = {
										method: 'PUT',
										url: 'http://localhost:8090/products/update/name/'+scope.product.target,
										data: $.param({
											nome: scope.product.name
										}),
										//data:{name:scope.product.name},
										headers: { 'Content-Type': 'application/x-www-form-urlencoded'}
									};
									$http(req)
									.success(function() {
										alert("Nome prodotto aggiunto correttamente!");
									})
									.error(function() {
										alert("Si è verificato un errore!");
									});
									};	
				//Questa funzione viene chiamata quando l'operatore preme su aggiungi qualità
				scope.controlloQualita = function(scope){
				//Dopo aver scelto la qualità il sistema chiede la conferma dell'operatore prima di andare avanti
						var message = "";
						console.log(scope.product.quality);
					if(scope.product.quality=='1' ){
						message = "Stai aggiungendo un prodotto di prima qualità! Sei sicuro?";
					}
					else if(scope.product.quality=='2'){
						message = "Stai aggiungendo un prodotto di seconda qualità! Sei sicuro?";
					}else {message = "Il prodotto verrà spedito in Atelier per le opportune riparazioni. Continuare?";}
					var request = confirm(message);
					//Se l'operatore ha cliccato su conferma allora effetua la registrazione della qualità!
				  if(request){
				var req = {
												method: 'PUT',
												url: 'http://localhost:8090/products/update/quality/'+scope.product.target,
												data: $.param({
													quality: scope.product.quality
												}),
												//data:{name:scope.product.name},								
												headers: { 'Content-Type': 'application/x-www-form-urlencoded'}
											};
												$http(req)
											.success(function() {
												alert("Qualità prodotto aggiunto correttamente!");		
												//Dopo che è stata aggiunta la qualità devo controllare se quaesta è 3:
												//In caso affermativo devo creare una riparazione con una nota 
													if(scope.product.quality=='3'){
														
														//Se la qualità è 3 non abbamo finito: mostriamo un altro form
														//per inserire la nota della riparazione
														
														document.getElementById("third").style.display="none";
														document.getElementById("four").style.display="block";
													}else{
													//Altimenti abbiamo finito e dovremmo ritornare al primo form per aggiungere un altro prodotto
													//Ovviamente reinizializziamo l'oggetto prodotto
													scope.product = {target : "", name : "", quality:0, category:"", provenance:"", description:"" };
													document.getElementById("third").style.display="none";
													document.getElementById("first").style.display="block";
													}
												})
											.error(function() {
												alert("Si è verificato un errore!");
											});
			}
					};
			scope.creaRiparazione = function(scope){
					$http(
															{
																method: 'POST',
																url: 'http://localhost:8090/products/create/repair',
																data: $.param({
																	target: scope.product.target,
																	note : scope.product.nota
																}),
																//data:{name:scope.product.name},
																headers: { 'Content-Type': 'application/x-www-form-urlencoded'}
															})
														.success(function() {
			alert("Riparazione per prodotto aggiunto correttamente!");
																//Dopo aver aggiunto la nota per la riparazione posso reinizializzare il prodotto dato
																//che dovrò crearne uno nuovo
																scope.product = {target : "", name : "", quality:0, category:"", provenance:"", description:"",nota:"" };
																document.getElementById("four").style.display="none";
														    document.getElementById("first").style.display="block";
															})
															.error(function() {
																alert("Si è verificato un errore!");
															});
						};
		});
</script>
</body>
</html>